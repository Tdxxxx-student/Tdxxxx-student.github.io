{{- define "main" }}

{{- /* =========================================================
     0. åˆå§‹åŒ–å˜é‡ (ä¿®å¤ä½œç”¨åŸŸå’Œç±»å‹é—®é¢˜)
     ========================================================= */ -}}
{{- $currentPage := . }}
{{- $categoryPages := slice }}
{{- $categoryName := "" }}

{{- /* 1. è·å–å½“å‰æ–‡ç« åˆ†ç±»ä¸‹çš„æ‰€æœ‰æ–‡ç«  */ -}}
{{- if .Params.categories }}
  {{- $categoryName = index .Params.categories 0 }}
  {{- $taxonomy := index .Site.Taxonomies.categories $categoryName }}
  {{- if $taxonomy }}
      {{- $categoryPages = $taxonomy.Pages.ByDate.Reverse }}
  {{- end }}
{{- end }}

{{- /* 2. å¦‚æœæ— åˆ†ç±»ï¼Œå›é€€åˆ°å…¨ç«™æ–‡ç«  */ -}}
{{- if eq (len $categoryPages) 0 }}
  {{- $categoryPages = where .Site.RegularPages "Type" "posts" }}
  {{- $categoryPages = $categoryPages.ByDate.Reverse }}
  {{- $categoryName = "å…¨éƒ¨æ–‡ç« " }}
{{- end }}

{{- /* 3. è®¡ç®—å½“å‰ä½ç½® */ -}}
{{- $total := len $categoryPages }}
{{- $current := 0 }}
{{- $prevPage := "" }}  {{- /* åˆå§‹åŒ–ä¸ºç©ºå­—ç¬¦ä¸² */ -}}
{{- $nextPage := "" }}  {{- /* åˆå§‹åŒ–ä¸ºç©ºå­—ç¬¦ä¸² */ -}}

{{- range $index, $page := $categoryPages }}
  {{- if eq $page.Permalink $currentPage.Permalink }}
    {{- $current = add $index 1 }}
    
    {{- /* ä¸Šä¸€ç¯‡ */ -}}
    {{- if gt $index 0 }}
      {{- $prevPage = index $categoryPages (sub $index 1) }}
    {{- end }}
    
    {{- /* ä¸‹ä¸€ç¯‡ */ -}}
    {{- if lt (add $index 1) $total }}
      {{- $nextPage = index $categoryPages (add $index 1) }}
    {{- end }}
  {{- end }}
{{- end }}

<!-- âš ï¸ å”¯ä¸€è¯†åˆ« ID -->
<div id="wide-post-layout" class="post-page-wrapper">
  
  <div class="top-banner-decoration"></div>

  <div class="page-layout">
    
    <article class="post-card">
      <header class="post-header">
        {{- partial "breadcrumbs.html" . }}
        <h1 class="post-title">{{ .Title }}</h1>
        {{- if .Description }}
        <div class="post-description">{{ .Description }}</div>
        {{- end }}
        {{- if not (.Param "hideMeta") }}
        <div class="post-meta">
          {{- partial "post_meta.html" . -}}
        </div>
        {{- end }}
      </header>

      <div class="post-content">
        {{- if not (.Param "disableAnchoredHeadings") }}
        {{- partial "anchored_headings.html" .Content -}}
        {{- else }}{{ .Content }}{{ end }}
      </div>
      
      {{- if .Params.tags }}
      <footer class="post-footer">
        <ul class="post-tags">
          {{- range .Params.tags }}
          <li><a href="{{ "tags/" | absURL }}{{ . | urlize }}">{{ . }}</a></li>
          {{- end }}
        </ul>
      </footer>
      {{- end }}

      <!-- =========================================================
           4. æ¸²æŸ“æ•°å­—é¡µç å¯¼èˆª
           ========================================================= -->
      <nav class="post-nav-full">
        <div class="nav-info">
            ç¬¬ <strong>{{ $current }}</strong> / {{ $total }} ç¯‡ 
            <span style="opacity: 0.6; font-size: 0.9em; margin-left: 5px;">(åˆ†ç±»: {{ $categoryName }})</span>
        </div>
        
        <div class="nav-buttons">
          {{- /* é¦–é¡µ */ -}}
          {{- if gt $current 1 }}
          <a class="nav-btn first" href="{{ (index $categoryPages 0).Permalink }}" title="ç¬¬ä¸€ç¯‡">Â«</a>
          {{- else }}
          <span class="nav-btn first disabled">Â«</span>
          {{- end }}
          
          {{- /* ä¸Šä¸€ç¯‡ (æ£€æŸ¥æ˜¯å¦ä¸ºç©º) */ -}}
          {{- if ne $prevPage "" }}
          <a class="nav-btn prev" href="{{ $prevPage.Permalink }}" title="{{ $prevPage.Title }}">â€¹</a>
          {{- else }}
          <span class="nav-btn prev disabled">â€¹</span>
          {{- end }}

          {{- /* æ•°å­—é¡µç ç»„ */ -}}
          <div class="nav-pages-group">
            {{- if gt $current 3 }}
            <span class="nav-dots">...</span>
            {{- end }}

            {{- range $i := seq (sub $current 2) (sub $current 1) }}
              {{- if gt $i 0 }}
                {{- $idx := sub $i 1 }}
                {{- $p := index $categoryPages $idx }}
                <a class="nav-num" href="{{ $p.Permalink }}" title="{{ $p.Title }}">{{ $i }}</a>
              {{- end }}
            {{- end }}

            <span class="nav-num current">{{ $current }}</span>

            {{- range $i := seq (add $current 1) (add $current 2) }}
              {{- if le $i $total }}
                {{- $idx := sub $i 1 }}
                {{- $p := index $categoryPages $idx }}
                <a class="nav-num" href="{{ $p.Permalink }}" title="{{ $p.Title }}">{{ $i }}</a>
              {{- end }}
            {{- end }}

            {{- if lt $current (sub $total 2) }}
            <span class="nav-dots">...</span>
            {{- end }}
          </div>

          {{- /* ä¸‹ä¸€ç¯‡ (æ£€æŸ¥æ˜¯å¦ä¸ºç©º) */ -}}
          {{- if ne $nextPage "" }}
          <a class="nav-btn next" href="{{ $nextPage.Permalink }}" title="{{ $nextPage.Title }}">â€º</a>
          {{- else }}
          <span class="nav-btn next disabled">â€º</span>
          {{- end }}
          
          {{- /* æœ«é¡µ */ -}}
          {{- if lt $current $total }}
          <a class="nav-btn last" href="{{ (index $categoryPages (sub $total 1)).Permalink }}" title="æœ€åä¸€ç¯‡">Â»</a>
          {{- else }}
          <span class="nav-btn last disabled">Â»</span>
          {{- end }}
        </div>
      </nav>
      
      {{- partial "comments.html" . -}}
    </article>

    <!-- å³ä¾§ï¼šæ‚¬æµ®ç›®å½• -->
    {{- if (.Param "ShowToc") }}
    <aside class="sidebar-right">
      <div class="toc-card">
        <div class="toc-title">
          <span class="toc-icon">ğŸ“–</span> ç›®å½•
        </div>
        <nav id="TableOfContents">
          {{ .TableOfContents }}
        </nav>
      </div>
    </aside>
    {{- end }}

  </div>
</div>

{{- end }}