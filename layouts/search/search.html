{{- define "main" }}

<div class="search-page">
  <header class="page-header">
    <h1>{{ .Title }}</h1>
  </header>

  <!-- æœç´¢æ¡† -->
  <div class="search-container">
    <div class="search-box">
      <span class="search-icon">ğŸ”</span>
      <input 
        type="text" 
        id="search-input" 
        class="search-input" 
        placeholder="è¾“å…¥å…³é”®å­—æœç´¢æ–‡ç« ..." 
        autocomplete="off"
        autofocus
      >
      <button id="search-clear" class="search-clear" title="æ¸…é™¤">Ã—</button>
    </div>
    <div class="search-info">
      <span id="search-count"></span>
    </div>
  </div>

  <!-- æœç´¢ç»“æœ -->
  <div id="search-results" class="search-results"></div>

  <!-- é»˜è®¤æ˜¾ç¤ºæ‰€æœ‰æ–‡ç«  -->
  <div id="all-posts" class="all-posts">
    <h2>å…¨éƒ¨æ–‡ç« </h2>
    <ul class="posts-list">
      {{- $pages := where .Site.RegularPages "Type" "posts" }}
      {{- range $pages.ByDate.Reverse }}
      <li class="post-entry">
        <span class="post-date">{{ .Date.Format "2006-01-02" }}</span>
        <a href="{{ .Permalink }}">{{ .Title }}</a>
      </li>
      {{- end }}
    </ul>
  </div>
</div>

<!-- æœç´¢è„šæœ¬ -->
<script>
(function() {
  const searchInput = document.getElementById('search-input');
  const searchClear = document.getElementById('search-clear');
  const searchResults = document.getElementById('search-results');
  const searchCount = document.getElementById('search-count');
  const allPosts = document.getElementById('all-posts');
  
  let searchIndex = [];

  // åŠ è½½æœç´¢ç´¢å¼•
  fetch('/index.json')
    .then(response => response.json())
    .then(data => {
      searchIndex = data;
    })
    .catch(error => {
      console.error('åŠ è½½æœç´¢ç´¢å¼•å¤±è´¥:', error);
    });

  // æœç´¢å‡½æ•°
  function performSearch(query) {
    if (!query || query.trim() === '') {
      searchResults.innerHTML = '';
      searchCount.textContent = '';
      allPosts.style.display = 'block';
      searchClear.style.display = 'none';
      return;
    }

    allPosts.style.display = 'none';
    searchClear.style.display = 'block';
    
    const keywords = query.toLowerCase().trim().split(/\s+/);
    
    const results = searchIndex.filter(item => {
      const title = (item.title || '').toLowerCase();
      const content = (item.content || '').toLowerCase();
      const categories = (item.categories || []).join(' ').toLowerCase();
      const tags = (item.tags || []).join(' ').toLowerCase();
      const searchText = title + ' ' + content + ' ' + categories + ' ' + tags;
      
      return keywords.every(keyword => searchText.includes(keyword));
    });

    displayResults(results, query);
  }

  // æ˜¾ç¤ºç»“æœ
  function displayResults(results, query) {
    if (results.length === 0) {
      searchResults.innerHTML = `
        <div class="no-results">
          <p>ğŸ˜” æ²¡æœ‰æ‰¾åˆ°ä¸ "<strong>${escapeHtml(query)}</strong>" ç›¸å…³çš„æ–‡ç« </p>
          <p>è¯•è¯•å…¶ä»–å…³é”®å­—ï¼Ÿ</p>
        </div>
      `;
      searchCount.textContent = 'æ‰¾åˆ° 0 ç¯‡æ–‡ç« ';
      return;
    }

    searchCount.textContent = `æ‰¾åˆ° ${results.length} ç¯‡æ–‡ç« `;
    
    let html = '<ul class="results-list">';
    results.forEach(item => {
      const title = highlightText(item.title, query);
      html += `
        <li class="result-item">
          <a href="${item.url}" class="result-link">
            <span class="result-title">${title}</span>
            <span class="result-date">${item.date}</span>
          </a>
          ${item.categories && item.categories.length ? 
            `<div class="result-meta">
              <span class="result-categories">${item.categories.join(', ')}</span>
            </div>` : ''
          }
        </li>
      `;
    });
    html += '</ul>';
    
    searchResults.innerHTML = html;
  }

  // é«˜äº®å…³é”®å­—
  function highlightText(text, query) {
    if (!text || !query) return text;
    const keywords = query.trim().split(/\s+/);
    let result = escapeHtml(text);
    keywords.forEach(keyword => {
      if (keyword) {
        const regex = new RegExp(`(${escapeRegex(keyword)})`, 'gi');
        result = result.replace(regex, '<mark>$1</mark>');
      }
    });
    return result;
  }

  // è½¬ä¹‰ HTML
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // è½¬ä¹‰æ­£åˆ™ç‰¹æ®Šå­—ç¬¦
  function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  // é˜²æŠ–å‡½æ•°
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // ç»‘å®šäº‹ä»¶
  searchInput.addEventListener('input', debounce(function(e) {
    performSearch(e.target.value);
  }, 300));

  searchInput.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      searchInput.value = '';
      performSearch('');
    }
  });

  searchClear.addEventListener('click', function() {
    searchInput.value = '';
    performSearch('');
    searchInput.focus();
  });

  // å¿«æ·é”® Ctrl+K æˆ– / èšç„¦æœç´¢æ¡†
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey && e.key === 'k') || (e.key === '/' && document.activeElement !== searchInput)) {
      e.preventDefault();
      searchInput.focus();
    }
  });
})();
</script>

{{- end }}