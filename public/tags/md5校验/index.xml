<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Md5校验 on 我的空间</title>
    <link>http://localhost:1313/tags/md5%E6%A0%A1%E9%AA%8C/</link>
    <description>Recent content in Md5校验 on 我的空间</description>
    <generator>Hugo -- 0.155.1</generator>
    <language>zh-cn</language>
    <copyright>tdx0307</copyright>
    <lastBuildDate>Wed, 04 Feb 2026 12:58:06 +0800</lastBuildDate>
    <atom:link href="http://localhost:1313/tags/md5%E6%A0%A1%E9%AA%8C/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>ENA校验脚本</title>
      <link>http://localhost:1313/posts/ena%E6%A0%A1%E9%AA%8C%E8%84%9A%E6%9C%AC/</link>
      <pubDate>Wed, 04 Feb 2026 12:58:06 +0800</pubDate>
      <guid>http://localhost:1313/posts/ena%E6%A0%A1%E9%AA%8C%E8%84%9A%E6%9C%AC/</guid>
      <description>&lt;p&gt;ENA下载的md5校验文件（tsv）格式转化和一键校验脚本
以下为脚本&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;#!/bin/bash
#===============================================================================
# 脚本名称: ena_md5_check.sh
# 功能描述: 自动转换ENA TSV文件并校验FASTQ文件完整性
# 作者: Claude Assistant
# 版本: 1.3
#===============================================================================

set -e

# 颜色定义
RED=&amp;#39;\033[0;31m&amp;#39;
GREEN=&amp;#39;\033[0;32m&amp;#39;
YELLOW=&amp;#39;\033[0;33m&amp;#39;
BLUE=&amp;#39;\033[0;34m&amp;#39;
NC=&amp;#39;\033[0m&amp;#39;

info()    { echo -e &amp;#34;${BLUE}[INFO]${NC} $1&amp;#34;; }
success() { echo -e &amp;#34;${GREEN}[SUCCESS]${NC} $1&amp;#34;; }
warn()    { echo -e &amp;#34;${YELLOW}[WARNING]${NC} $1&amp;#34;; }
error()   { echo -e &amp;#34;${RED}[ERROR]${NC} $1&amp;#34;; exit 1; }

# 显示帮助信息
show_help() {
    cat &amp;lt;&amp;lt; EOF
================================================================================
ENA FASTQ MD5 校验工具 v1.3
================================================================================

用法: $0 &amp;lt;tsv文件&amp;gt; [fastq目录] [选项]

参数:
    &amp;lt;tsv文件&amp;gt;       ENA下载的filereport TSV文件 (必需)
    [fastq目录]     FASTQ文件所在目录 (默认: 当前目录)

选项:
    -s, --suffix    文件后缀 (默认: .fastq.gz)
    -o, --output    输出的MD5文件名 (默认: md5sums.txt)
    -r, --report    问题报告文件名 (默认: md5_failed_report.tsv)
    -h, --help      显示此帮助信息

支持:
    - 双端测序 (paired-end): SRR*_1.fastq.gz, SRR*_2.fastq.gz
    - 单端测序 (single-end): SRR*.fastq.gz

输出文件:
    md5sums.txt             生成的MD5校验文件
    md5_failed_report.tsv   仅当有问题时生成 (TSV格式)

示例:
    $0 filereport_read_run_PRJNA175477.tsv
    $0 filereport_read_run_PRJNA175477.tsv ./rawdata -s .fq.gz

================================================================================
EOF
    exit 0
}

# 默认参数
TSV_FILE=&amp;#34;&amp;#34;
FASTQ_DIR=&amp;#34;.&amp;#34;
SUFFIX=&amp;#34;.fastq.gz&amp;#34;
OUTPUT=&amp;#34;md5sums.txt&amp;#34;
REPORT=&amp;#34;md5_failed_report.tsv&amp;#34;

# 参数解析
while [[ $# -gt 0 ]]; do
    case $1 in
        -s|--suffix) SUFFIX=&amp;#34;$2&amp;#34;; shift 2 ;;
        -o|--output) OUTPUT=&amp;#34;$2&amp;#34;; shift 2 ;;
        -r|--report) REPORT=&amp;#34;$2&amp;#34;; shift 2 ;;
        -h|--help) show_help ;;
        -*) error &amp;#34;未知选项: $1&amp;#34; ;;
        *)
            if [[ -z &amp;#34;$TSV_FILE&amp;#34; ]]; then
                TSV_FILE=&amp;#34;$1&amp;#34;
            else
                FASTQ_DIR=&amp;#34;$1&amp;#34;
            fi
            shift
            ;;
    esac
done

# 参数检查
[[ -z &amp;#34;$TSV_FILE&amp;#34; ]] &amp;amp;&amp;amp; error &amp;#34;请指定TSV文件，使用 -h 查看帮助&amp;#34;
[[ ! -f &amp;#34;$TSV_FILE&amp;#34; ]] &amp;amp;&amp;amp; error &amp;#34;TSV文件不存在: $TSV_FILE&amp;#34;
[[ ! -d &amp;#34;$FASTQ_DIR&amp;#34; ]] &amp;amp;&amp;amp; error &amp;#34;FASTQ目录不存在: $FASTQ_DIR&amp;#34;

FASTQ_DIR=$(cd &amp;#34;$FASTQ_DIR&amp;#34; &amp;amp;&amp;amp; pwd)

info &amp;#34;==========================================&amp;#34;
info &amp;#34;ENA FASTQ MD5 校验工具 v1.3&amp;#34;
info &amp;#34;==========================================&amp;#34;
info &amp;#34;TSV文件:   $TSV_FILE&amp;#34;
info &amp;#34;FASTQ目录: $FASTQ_DIR&amp;#34;
info &amp;#34;文件后缀:  $SUFFIX&amp;#34;
info &amp;#34;==========================================&amp;#34;

#===============================================================================
# 步骤1: 转换TSV为MD5格式（支持单端和双端）
#===============================================================================
info &amp;#34;正在转换TSV文件...&amp;#34;

awk -F&amp;#39;\t&amp;#39; -v suffix=&amp;#34;$SUFFIX&amp;#34; -v dir=&amp;#34;$FASTQ_DIR&amp;#34; &amp;#39;
{
    gsub(/\r/, &amp;#34;&amp;#34;)
    if ($1 ~ /^[SE]RR[0-9]+$/ &amp;amp;&amp;amp; $2 != &amp;#34;&amp;#34;) {
        srr = $1
        md5_str = $2
        n = split(md5_str, md5s, &amp;#34;;&amp;#34;)
        
        if (n == 2) {
            # 双端测序
            printf &amp;#34;%s  %s/%s_1%s\n&amp;#34;, md5s[1], dir, srr, suffix
            printf &amp;#34;%s  %s/%s_2%s\n&amp;#34;, md5s[2], dir, srr, suffix
        } else if (n == 1 &amp;amp;&amp;amp; md5s[1] != &amp;#34;&amp;#34;) {
            # 单端测序
            printf &amp;#34;%s  %s/%s%s\n&amp;#34;, md5s[1], dir, srr, suffix
        }
    }
}&amp;#39; &amp;#34;$TSV_FILE&amp;#34; &amp;gt; &amp;#34;$OUTPUT&amp;#34;

count=$(wc -l &amp;lt; &amp;#34;$OUTPUT&amp;#34;)
[[ $count -eq 0 ]] &amp;amp;&amp;amp; error &amp;#34;未能提取任何MD5记录，请检查TSV文件格式&amp;#34;

success &amp;#34;生成MD5文件: $OUTPUT ($count 条记录)&amp;#34;
info &amp;#34;预览前5行:&amp;#34;
head -5 &amp;#34;$OUTPUT&amp;#34; | sed &amp;#39;s/^/    /&amp;#39;

#===============================================================================
# 步骤2: 校验文件完整性
#===============================================================================
echo &amp;#34;&amp;#34;
info &amp;#34;开始校验文件完整性...&amp;#34;
info &amp;#34;(大文件需要较长时间，请耐心等待)&amp;#34;
echo &amp;#34;&amp;#34;

total=$count
current=0
passed=0
failed=0
missing=0

# 临时存储问题文件（TSV格式：文件名\t原因）
FAILED_TMP=$(mktemp)

while read -r line; do
    current=$((current + 1))
    
    expected_md5=$(echo &amp;#34;$line&amp;#34; | awk &amp;#39;{print $1}&amp;#39;)
    filepath=$(echo &amp;#34;$line&amp;#34; | sed &amp;#39;s/^[^ ]*  //&amp;#39;)
    filename=$(basename &amp;#34;$filepath&amp;#34;)
    
    printf &amp;#34;[%d/%d] %s ... &amp;#34; &amp;#34;$current&amp;#34; &amp;#34;$total&amp;#34; &amp;#34;$filename&amp;#34;
    
    # 检查文件是否存在
    if [[ ! -f &amp;#34;$filepath&amp;#34; ]]; then
        echo -e &amp;#34;${YELLOW}缺失${NC}&amp;#34;
        missing=$((missing + 1))
        printf &amp;#34;%s\t%s\n&amp;#34; &amp;#34;$filename&amp;#34; &amp;#34;文件不存在&amp;#34; &amp;gt;&amp;gt; &amp;#34;$FAILED_TMP&amp;#34;
        continue
    fi
    
    # 计算MD5
    actual_md5=$(md5sum &amp;#34;$filepath&amp;#34; | awk &amp;#39;{print $1}&amp;#39;)
    
    if [[ &amp;#34;$expected_md5&amp;#34; == &amp;#34;$actual_md5&amp;#34; ]]; then
        echo -e &amp;#34;${GREEN}OK${NC}&amp;#34;
        passed=$((passed + 1))
    else
        echo -e &amp;#34;${RED}FAILED${NC}&amp;#34;
        failed=$((failed + 1))
        printf &amp;#34;%s\t%s\n&amp;#34; &amp;#34;$filename&amp;#34; &amp;#34;MD5不匹配(期望:${expected_md5},实际:${actual_md5})&amp;#34; &amp;gt;&amp;gt; &amp;#34;$FAILED_TMP&amp;#34;
    fi
    
done &amp;lt; &amp;#34;$OUTPUT&amp;#34;

#===============================================================================
# 步骤3: 输出统计结果
#===============================================================================
echo &amp;#34;&amp;#34;
info &amp;#34;==========================================&amp;#34;
info &amp;#34;校验完成！统计结果:&amp;#34;
info &amp;#34;==========================================&amp;#34;
echo &amp;#34;  总计: $total&amp;#34;
echo -e &amp;#34;  ${GREEN}通过: $passed${NC}&amp;#34;
echo -e &amp;#34;  ${RED}失败: $failed${NC}&amp;#34;
echo -e &amp;#34;  ${YELLOW}缺失: $missing${NC}&amp;#34;
info &amp;#34;==========================================&amp;#34;

#===============================================================================
# 步骤4: 仅当有问题时生成报告（TSV格式）
#===============================================================================
if [[ $failed -gt 0 || $missing -gt 0 ]]; then
    # 生成TSV报告：表头 + 内容
    echo -e &amp;#34;filename\treason&amp;#34; &amp;gt; &amp;#34;$REPORT&amp;#34;
    cat &amp;#34;$FAILED_TMP&amp;#34; &amp;gt;&amp;gt; &amp;#34;$REPORT&amp;#34;
    
    echo &amp;#34;&amp;#34;
    warn &amp;#34;问题文件列表:&amp;#34;
    echo -e &amp;#34;${YELLOW}filename\treason${NC}&amp;#34;
    cat &amp;#34;$FAILED_TMP&amp;#34;
    echo &amp;#34;&amp;#34;
    warn &amp;#34;✗ 存在问题文件！&amp;#34;
    success &amp;#34;问题报告已保存至: $REPORT&amp;#34;
else
    rm -f &amp;#34;$REPORT&amp;#34;
    echo &amp;#34;&amp;#34;
    success &amp;#34;✓ 所有文件校验通过！无问题报告生成。&amp;#34;
fi

# 清理
rm -f &amp;#34;$FAILED_TMP&amp;#34;

[[ $failed -gt 0 || $missing -gt 0 ]] &amp;amp;&amp;amp; exit 1 || exit 0
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;更新说明&#34;&gt;更新说明&lt;/h2&gt;
&lt;h3 id=&#34;1-支持单端测序&#34;&gt;1. 支持单端测序&lt;/h3&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;测序类型&lt;/th&gt;
          &lt;th&gt;MD5格式&lt;/th&gt;
          &lt;th&gt;生成文件&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;双端&lt;/td&gt;
          &lt;td&gt;&lt;code&gt;md5_1;md5_2&lt;/code&gt;&lt;/td&gt;
          &lt;td&gt;&lt;code&gt;SRR*_1.fastq.gz&lt;/code&gt;, &lt;code&gt;SRR*_2.fastq.gz&lt;/code&gt;&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;单端&lt;/td&gt;
          &lt;td&gt;&lt;code&gt;md5&lt;/code&gt;&lt;/td&gt;
          &lt;td&gt;&lt;code&gt;SRR*.fastq.gz&lt;/code&gt;&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id=&#34;2-错误报告格式tsv&#34;&gt;2. 错误报告格式（TSV）&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;filename	reason
SRR576084_1.fastq.gz	MD5不匹配(期望:ee9c08fd...,实际:a1b2c3d4...)
SRR576089_1.fastq.gz	文件不存在
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;使用方法&#34;&gt;使用方法&lt;/h2&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;chmod +x ena_md5_check.sh

# 基本用法
./ena_md5_check.sh filereport_read_run_PRJNA175477.tsv .

# 指定目录和后缀
./ena_md5_check.sh filereport.tsv ./rawdata -s .fq.gz

# 查看错误报告
cat md5_failed_report.tsv

# 用Excel或其他工具打开TSV报告
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&#34;输出示例&#34;&gt;输出示例&lt;/h2&gt;
&lt;h3 id=&#34;终端输出&#34;&gt;终端输出&lt;/h3&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[INFO] ==========================================
[INFO] ENA FASTQ MD5 校验工具 v1.3
[INFO] ==========================================
[1/10] SRR064552_1.fastq.gz ... OK
[2/10] SRR064552_2.fastq.gz ... OK
[3/10] SRR064553.fastq.gz ... OK        # 单端测序
[4/10] SRR064554_1.fastq.gz ... FAILED
[5/10] SRR064554_2.fastq.gz ... 缺失
...
[INFO] ==========================================
[INFO] 校验完成！统计结果:
[INFO] ==========================================
  总计: 10
  通过: 8
  失败: 1
  缺失: 1
[INFO] ==========================================

[WARNING] 问题文件列表:
filename	reason
SRR064554_1.fastq.gz	MD5不匹配(期望:ee9c08fd...,实际:a1b2c3d4...)
SRR064554_2.fastq.gz	文件不存在

[SUCCESS] 问题报告已保存至: md5_failed_report.tsv
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&#34;错误报告文件-md5_failed_reporttsv&#34;&gt;错误报告文件 (md5_failed_report.tsv)&lt;/h3&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;filename&lt;/th&gt;
          &lt;th&gt;reason&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;SRR064554_1.fastq.gz&lt;/td&gt;
          &lt;td&gt;MD5不匹配(期望:ee9c08fd&amp;hellip;,实际:a1b2c3d4&amp;hellip;)&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;SRR064554_2.fastq.gz&lt;/td&gt;
          &lt;td&gt;文件不存在&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;</description>
    </item>
  </channel>
</rss>
